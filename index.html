<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¯¸êµ¬ë§¤ ë¬¸ì ìë™ì™„ì„± íˆ´</title>
  <style>
    :root {
      --bg: #f5f6f8;
      --text: #111827;
      --card: white;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --border: #d1d5db;
      --success: #10b981;
      --success-hover: #059669;
      --danger: #ef4444;
      --warn: #f97316;
      --warn-hover: #ea580c;
    }

    body.dark {
      --bg: #1f2937;
      --text: #f9fafb;
      --card: #374151;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
      --border: #4b5563;
      --success: #34d399;
      --success-hover: #10b981;
      --danger: #f87171;
      --warn: #fb923c;
      --warn-hover: #f97316;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    header {
      background-color: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      position: relative;
    }

    #darkModeToggle {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 18px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    .top-bar {
      background-color: #e5e7eb;
      padding: 12px 30px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    body.dark .top-bar {
      background-color: #374151;
    }

    .top-bar label {
      font-weight: bold;
      white-space: nowrap;
    }

    #branch, #modeSelect, #adminPassword, #productSearch {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: white;
      color: #111;
    }

    #branch {
      width: 150px;
    }

    #modeSelect {
      min-width: 110px;
    }

    #adminPassword {
      width: 140px;
    }
    
    #productSearch {
      margin-left: auto; /* Push search bar to the right */
      width: 200px;
    }

    body.dark #branch,
    body.dark #modeSelect,
    body.dark #adminPassword,
    body.dark #productSearch {
      background: #1f2937;
      color: white;
      border: 1px solid var(--border);
    }

    #adminLoginBtn {
      background: var(--primary);
      color: white;
      border-radius: 6px;
      border: none;
      padding: 10px 20px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }

    #adminLoginBtn:hover {
      background: var(--primary-hover);
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      padding: 20px 30px;
      gap: 20px;
    }

    .category {
      width: 200px;
      background: var(--card);
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .category-header {
      position: sticky;
      top: 0;
      background: var(--card);
      font-weight: bold;
      padding: 5px 0;
      border-bottom: 1px solid var(--border);
      z-index: 1;
    }

    .product-button {
      color: black;
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #f3f4f6;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: background 0.3s, border-color 0.3s;
    }

    .product-button.selected {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary-hover);
    }

    #output {
      margin: 0 30px;
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      min-height: 300px;
      white-space: pre-wrap;
      font-size: 15px;
      line-height: 1.5;
    }

    .buttons {
      display: flex;
      justify-content: flex-end;
      margin: 20px 30px;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
    }

    #deselectBtn {
      background: var(--warn);
    }
    #deselectBtn:hover {
      background: var(--warn-hover);
    }

    #generateBtn {
      background: var(--primary);
    }

    #generateBtn:hover {
      background: var(--primary-hover);
    }

    #copyBtn {
      background: var(--success);
      display: none;
    }

    #copyBtn:hover {
      background: var(--success-hover);
    }

    .admin-panel {
      display: none;
      margin: 30px;
      padding: 20px;
      background: #fefce8;
      border: 1px solid #facc15;
      border-radius: 10px;
    }

    body.dark .admin-panel {
      background: #4b5563;
      border-color: #facc15;
    }

    .admin-panel input {
      width: calc(33% - 12px);
      margin-right: 12px;
      margin-bottom: 10px;
    }

    .admin-panel button {
      background: var(--primary);
    }

    .admin-list {
      margin-top: 20px;
    }

    /* ê´€ë¦¬ì ëª¨ë“œ ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í´ê¸° ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .brand-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      cursor: grab;
    }
    .brand-item .toggle-btn {
      cursor: pointer;
      font-size: 1.2em;
      transition: transform 0.2s;
    }
    .brand-item[data-collapsed="true"] .toggle-btn {
      transform: rotate(-90deg);
    }

    .brand-item.dragging {
      opacity: 0.5;
    }

    .brand-handle {
      user-select: none;
      cursor: grab;
    }

    .admin-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
    }

    .admin-item span {
      flex-grow: 1;
    }

    .admin-item input {
      padding: 4px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }
    .admin-item.hidden {
      display: none;
    }

    .draggable-handle {
      cursor: grab;
      user-select: none;
    }

  </style>
</head>
<body>
  <header>
    ë¯¸êµ¬ë§¤ ë¬¸ì ìë™ì™„ì„± íˆ´
    <button id="darkModeToggle" onclick="toggleDarkMode()">ğŸŒ™</button>
  </header>

  <div class="top-bar">
    <label for="branch">ì§€ì ëª…</label>
    <input type="text" id="branch" placeholder="ì˜ˆ: ë…¸ì›ì " />
    <label for="modeSelect" style="margin-left: 20px;">ëª¨ë“œ ì„ íƒ</label>
    <select id="modeSelect">
      <option value="user" selected>ì‚¬ìš©ì</option>
      <option value="admin">ê´€ë¦¬ì ëª¨ë“œ</option>
    </select>
    <!-- í•´ë‹¹ ìš”ì†Œë“¤ì€ 'ì‚¬ìš©ì' ëª¨ë“œì—ì„œëŠ” ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤. -->
    <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" style="margin-left: 10px; display:none;" />
    <button id="adminLoginBtn" style="display:none; margin-left: 10px;">ë¡œê·¸ì¸</button>
    <!-- ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€ -->
    <input type="text" id="productSearch" placeholder="ì œí’ˆ ê²€ìƒ‰" />
  </div>

  <div class="grid" id="categories"></div>

  <div class="buttons">
    <button id="deselectBtn" onclick="deselectAllProducts()">ì „ì²´ì·¨ì†Œ</button>
    <button id="generateBtn" onclick="generateMessage()">ë©”ì‹œì§€ ìƒì„±</button>
    <button id="copyBtn" onclick="copyMessage()">ë³µì‚¬í•˜ê¸°</button>
  </div>

  <div id="output"></div>

  <div class="admin-panel" id="adminPanel">
    <h3>ì œí’ˆ ë° ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>
    <p class="text-xs text-gray-600 mb-4">ëª¨ë“  ë³€ê²½ ì‚¬í•­ì€ Firebase Firestoreì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
    <input type="text" id="adminBrand" placeholder="ë¸Œëœë“œëª…" />
    <input type="text" id="adminName" placeholder="ì œí’ˆëª…" />
    <input type="text" id="adminURL" placeholder="ì œí’ˆ URL" />
    <button onclick="addProduct()">+ ì œí’ˆ ì¶”ê°€</button>

    <div class="admin-list" id="adminList"></div>
  </div>

  <script type="module">
    // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ì „ì—­ ë³€ìˆ˜ ì„¤ì • (í”Œë«í¼ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë¨)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;
    let currentUserId = null;
    let isFirebaseReady = false;
    const CONFIG_DOC_PATH = "app_configs"; // Firestore ì»¬ë ‰ì…˜ ì´ë¦„
    const CONFIG_DOC_ID = "sms_tool_config"; // Firestore ë¬¸ì„œ ID

    // ê¸°ë³¸ ì œí’ˆ ë°ì´í„° (Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•  ê²½ìš° ì‚¬ìš©)
    const defaultProducts = {
      "Z11 (ë¯¸ë””ì—„)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/15POhev" },
      "Z11 (ì†Œí”„íŠ¸)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/BeKrYbz" },
      "Z11 (í•˜ë“œ)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/3COUTOA" },
      "Z10B (ë¯¸ë””ì—„)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/44yHNYX" },
      "Z10B (ì†Œí”„íŠ¸)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/1c9TId6" },
      "Z10B (í•˜ë“œ)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/Yf7lEM" },
      "Z10 (ë¯¸ë””ì—„)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/8IwSvDm" },
      "Z10 (ì†Œí”„íŠ¸)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/8IwSvE1" },
      "Z10 (í•˜ë“œ)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/B7aacGl" },
      "Z8B (ë¯¸ë””ì—„)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/HHd6wqW" },
      "Z8B (ì†Œí”„íŠ¸)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/H6iLy29" },
      "Z8B (í•˜ë“œ)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/5fD6Czc" },
      "Z7 (ë¯¸ë””ì—„)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/G3Do59M" },
      "Z7 (ì†Œí”„íŠ¸)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/31TjUmf" },
      "Z7 (í•˜ë“œ)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/NkMmXQ" },
      "Z5 (ë¯¸ë””ì—„)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/15POhpH" },
      "Z5 (ì†Œí”„íŠ¸)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/FhOI7Xj" },
      "Z5 (í•˜ë“œ)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/8elystx" },
      "L3": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/1ujocT" },
      "W3": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/6Ms88LB" },
      "M5": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/2JohZa5" },
      "M3": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/3j8vVR5" },
      "M2": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/Aaq4LdF" },
      "Z11ë² ì´ìŠ¤ (ë¸”ë£¨)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/1c9o1H5" },
      "Z11ë² ì´ìŠ¤ (ê·¸ë ˆì´)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/HHdFJsJ" },
      "Z11ë² ì´ìŠ¤ (ë¸Œë¼ìš´)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/ChpIY1F" },
      "Z0 (ë¸”ë£¨)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/31Trrjz" },
      "Z0 (ë¼ì´íŠ¸ê·¸ë ˆì´)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/CpkAgH" },
      "Z0 (ë¸Œë¼ìš´)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/A46Cos7" },
      "Z0 (ë‹¤í¬ê·¸ë ˆì´)": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/3YE8oAr" },
      "íˆíŠ¸ê°€ë”": { brand: "ë² ìŠ¤íŠ¸ìŠ¬ë¦½", url: "https://buly.kr/E79dNqL" },
      "ì´ì¼ˆë¡œìŠ¤23 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/1v0uPt" },
      "ì´ì¼ˆë¡œìŠ¤23 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/1v0uPt" },
      "ëª¨í”¼ì–´ìŠ¤22 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/6MsIDnk" },
      "ëª¨í”¼ì–´ìŠ¤22 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/6MsIDnk" },
      "íŒíƒ€ì†ŒìŠ¤21 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/7x7739M" },
      "íŒíƒ€ì†ŒìŠ¤21 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/7x7739M" },
      "ë…¹í„´19 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/74XK94m" },
      "ë…¹í„´19 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/74XK94m" },
      "ì´ì¼ˆë¡œìŠ¤23 í† í¼ (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/G3DyAiS" },
      "ì´ì¼ˆë¡œìŠ¤23 í† í¼ (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/G3DyAiS" },
      "ëª¨í”¼ì–´ìŠ¤22 í† í¼ (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/EdtuKC7" },
      "ëª¨í”¼ì–´ìŠ¤22 í† í¼ (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/EdtuKC7" },
      "ë…¹í„´19 í† í¼ (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/BpFmd9K" },
      "ë…¹í„´19 í† í¼ (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/BpFmd9K" },
      "ì´ì¼ˆë¡œìŠ¤23 ë² ì´ìŠ¤": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/GZyF7C9" },
      "ëª¨í”¼ì–´ìŠ¤22 ë² ì´ìŠ¤": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/2qYivza" },
      "ë…¹í„´19 ë² ì´ìŠ¤": { brand: "ë¸Œëœë“œë¦¬ìŠ¤", url: "https://buly.kr/3u3gURs" },
      "P7 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/881s278" },
      "P7 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/DwEsP2T" },
      "G5 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/3j8vVj4" },
      "G5 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/3u3gUXt" },
      "C5": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/B7aki04" },
      "C4 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/2Ujce2q" },
      "C4 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/2Ujce2q" },
      "C4 ì¼ì²´í˜• (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/FsJDC3K" },
      "C4 ì¼ì²´í˜• (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/FsJDC3K" },
      "C3": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/612mGMD" },
      "S6": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/AllEkOq" },
      "S5 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/H6iW3m6" },
      "S5 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/H6iW3m6" },
      "S4 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/3NJPY94" },
      "S4 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/3NJPY94" },
      "ì¿¨ì•¤ì›œ ë§¤íŠ¸ë¦¬ìŠ¤ í† í¼": { brand: "ì—˜ë¼ë¹„ì•„", url: "https://buly.kr/BpFmdJL" },
      "Q3000 (ë¯¸ë””ì—„)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/9BW1GzZ" },
      "Q3000 (ì†Œí”„íŠ¸)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/9BW1GzZ" },
      "Q3000 (í•˜ë“œ)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/9BW1GzZ" },
      "Q3 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/3YDprfH" },
      "Q3 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/3YDprfH" },
      "Q4 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/6BxN9hl" },
      "Q4 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/6BxN9hl" },
      "Q7 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/BIVLbNA" },
      "Q7 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/BIVLbNA" },
      "Q8 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/H6i74Kx" },
      "Q8 (ë¯¸ë””ì—„ í•˜ë“œ)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/H6i74Kx" },
      "Q9 (ë¯¸ë””ì—„ ì†Œí”„íŠ¸)": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/C0ANWeJ" },
      "SB3": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/90bewNl" },
      "SB5": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/4xYENcC" },
      "V3": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/9BWPvHg" },
      "V4": { brand: "í€µìŠ¬ë¦½", url: "https://buly.kr/FLYpJh6" },
      "RC2": { brand: "ë¡¤ë§ì»´í¬íŠ¸", url: "https://buly.kr/AwfzjFq" },
    };

    // ì €ì¥ëœ ì œí’ˆ ë°ì´í„° ë° ì œí’ˆ ìˆœì„œ / ë¸Œëœë“œ ìˆœì„œ. ì´ì œ localStorage ëŒ€ì‹  Firestoreì—ì„œ ë¡œë“œë¨.
    // ì´ˆê¸°ì—ëŠ” ê¸°ë³¸ê°’ ë˜ëŠ” ë¹ˆ ê°ì²´ë¡œ ì‹œì‘.
    let productData = defaultProducts; 
    let productOrder = {};
    let brandOrder = [];
    let collapsedState = {};

    /**
     * Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©ì ì¸ì¦ ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
     */
    async function initFirebase() {
        if (!firebaseConfig) {
            console.error("ì˜¤ë¥˜: Firebase ì„¤ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        try {
            // 1. Firebase ì•± ì´ˆê¸°í™”
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 2. ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    isFirebaseReady = true;
                    console.log("Firebase ì¸ì¦ ì„±ê³µ. User ID:", currentUserId);
                    loadDataFromFirebase(); // ì¸ì¦ í›„ ë°ì´í„° ë¡œë“œ ì‹œì‘
                } else {
                    currentUserId = null;
                    isFirebaseReady = false;
                    console.log("Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½: ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜");
                    // ìµëª… ë¡œê·¸ì¸ ë˜ëŠ” ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸ ì‹œë„
                    if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken).catch(err => {
                             console.error("Custom token ë¡œê·¸ì¸ ì‹¤íŒ¨:", err);
                             signInAnonymously(auth); // ìµëª… ë¡œê·¸ì¸ìœ¼ë¡œ ëŒ€ì²´ ì‹œë„
                        });
                    } else {
                        signInAnonymously(auth);
                    }
                }
            });

        } catch (error) {
            console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    /**
     * Cloud Firestoreì—ì„œ ì‚¬ìš©ì ì„¤ì • ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤ (onSnapshot ì‚¬ìš©).
     */
    function loadDataFromFirebase() {
        if (!isFirebaseReady || !currentUserId) return;

        // DB ê²½ë¡œ: /artifacts/{appId}/users/{userId}/app_configs/sms_tool_config
        const configDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, CONFIG_DOC_PATH, CONFIG_DOC_ID);
        
        onSnapshot(configDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                // Firestoreì—ì„œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ë°˜ì˜
                productData = data.products || defaultProducts;
                productOrder = data.productOrder || {};
                brandOrder = data.brandOrder || [];
                collapsedState = data.collapsedState || {};
                console.log("Firestoreì—ì„œ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                console.log("ì„¤ì • ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë°ì´í„° ì‚¬ìš© ë° Firestoreì— ì €ì¥ ì‹œë„.");
                // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥í•˜ì—¬ ì´ˆê¸°í™”
                saveAllData(true); 
            }
            // ë°ì´í„° ë¡œë“œ ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì • í›„ UI ë Œë”ë§
            renderCategories();
            // ê´€ë¦¬ì íŒ¨ë„ì´ ì—´ë ¤ìˆë‹¤ë©´ ëª©ë¡ë„ ê°±ì‹ 
            if (document.getElementById("adminPanel").style.display === "block") {
                renderAdminList();
            }
        }, (error) => {
            console.error("Firestoreì—ì„œ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (onSnapshot):", error);
        });
    }

    /**
     * ëª¨ë“  ì„¤ì • ë°ì´í„°ë¥¼ Cloud Firestoreì— ì €ì¥í•©ë‹ˆë‹¤ (localStorage ëŒ€ì²´).
     * @param {boolean} force - Firebase ì¤€ë¹„ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì €ì¥ ì‹œë„ (ì´ˆê¸° ë°ì´í„° ì €ì¥ìš©)
     */
    async function saveAllData(force = false) {
        if (!isFirebaseReady || !currentUserId) {
            if (!force) console.warn("Firebaseê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        try {
            const configDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, CONFIG_DOC_PATH, CONFIG_DOC_ID);

            const dataToSave = {
                products: productData,
                productOrder: productOrder,
                brandOrder: brandOrder,
                collapsedState: collapsedState,
                lastUpdated: new Date().toISOString()
            };

            // setDocì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì„œì— ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.
            await setDoc(configDocRef, dataToSave);
            // console.log("ë°ì´í„°ê°€ Firestoreì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
            console.error("Firestoreì— ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }


    function groupByBrand(data) {
      const map = {};
      for (const name in data) {
        const brand = data[name].brand;
        if (!map[brand]) map[brand] = [];
        map[brand].push(name);
      }
      return map;
    }

    // ë¸Œëœë“œë³„ ìˆœì„œ ì´ˆê¸°í™”
    function ensureBrandOrder() {
      const grouped = groupByBrand(productData);
      const brands = Object.keys(grouped);
      // ë¸Œëœë“œ ìˆœì„œê°€ ë¹„ì–´ìˆê±°ë‚˜ ë¸Œëœë“œ ë³€ê²½ ì‹œ ë™ê¸°í™”
      if (brandOrder.length === 0) {
        brandOrder = brands.slice();
      } else {
        // brandOrderì— ì—†ëŠ” ë¸Œëœë“œ ì¶”ê°€
        brands.forEach(b => {
          if (!brandOrder.includes(b)) brandOrder.push(b);
        });
        // brandOrderì— ìˆì§€ë§Œ ì œí’ˆDataì—ì„œ ë¸Œëœë“œ ì‚¬ë¼ì§„ ê²½ìš° ì œê±°
        brandOrder = brandOrder.filter(b => brands.includes(b));
      }
    }

    // ë¸Œëœë“œë³„ ì œí’ˆ ìˆœì„œ ì´ˆê¸°í™”
    function ensureProductOrder() {
      const grouped = groupByBrand(productData);
      for (const brand in grouped) {
        if (!productOrder[brand]) {
          productOrder[brand] = grouped[brand].slice();
        } else {
          // ì‚­ì œëœ ì œí’ˆ ì œê±°
          const existing = productOrder[brand];
          const names = grouped[brand];
          productOrder[brand] = existing.filter(n => names.includes(n));
          names.forEach(n => {
            if (!productOrder[brand].includes(n)) {
              productOrder[brand].push(n);
            }
          });
        }
      }
      // ë¸Œëœë“œ ì‚¬ë¼ì§„ ê²½ìš° productOrderì—ì„œ ì •ë¦¬
      for (const brand in productOrder) {
        if (!(brand in groupByBrand(productData))) {
          delete productOrder[brand];
        }
      }
    }


    function renderCategories() {
      const container = document.getElementById("categories");
      container.innerHTML = "";
      ensureBrandOrder();
      ensureProductOrder();
      const grouped = groupByBrand(productData);

      // ë¸Œëœë“œ ìˆœì„œì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ ë Œë”
      brandOrder.forEach(brand => {
        if (!(brand in grouped)) return;
        const div = document.createElement("div");
        div.className = "category";

        if (grouped[brand].length > 3) {
          div.style.maxHeight = "200px";
          div.style.overflowY = "auto";
        }

        const brandHeader = document.createElement("div");
        brandHeader.className = "category-header";
        brandHeader.textContent = brand;
        div.appendChild(brandHeader);

        // ì œí’ˆ ë‚´ ìˆœì„œëŒ€ë¡œ ë²„íŠ¼ ë°°ì¹˜
        productOrder[brand].forEach(name => {
          if (!(name in productData)) return;
          const btn = document.createElement("button");
          btn.textContent = name;
          btn.className = "product-button";
          btn.onclick = () => btn.classList.toggle("selected");
          div.appendChild(btn);
        });

        container.appendChild(div);
      });
    }
    
    // ì œí’ˆ ê²€ìƒ‰ ê¸°ëŠ¥
    const productSearchInput = document.getElementById('productSearch');
    productSearchInput.addEventListener('keyup', (event) => {
        const searchTerm = event.target.value.trim().toLowerCase();
        const productButtons = document.querySelectorAll('.product-button');
        
        productButtons.forEach(button => {
            const productName = button.textContent.toLowerCase();
            if (productName.includes(searchTerm)) {
                button.style.display = 'block';
            } else {
                button.style.display = 'none';
            }
        });
    });

    function generateMessage() {
      const branch = document.getElementById("branch").value.trim();
      if (!branch) {
        // alert ëŒ€ì‹  ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ ì‚¬ìš©
        showMessageBox("ì§€ì ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warn");
        return;
      }

      const selected = document.querySelectorAll(".product-button.selected");
      if (selected.length === 0) {
        // alert ëŒ€ì‹  ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ ì‚¬ìš©
        showMessageBox("ì œí’ˆì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.", "warn");
        return;
      }

      const names = [...selected].map(btn => btn.textContent);
      let detail = "";
      names.forEach(name => {
        const info = productData[name];
        if (info) detail += `[${info.brand}] ${name}\n(${info.url})\n\n`;
      });

      const message = `
ì•ˆë…•í•˜ì„¸ìš”, ê³ ê°ë‹˜ 
ë°©ë¬¸í•´ ì£¼ì…¨ë˜ ë² ìŠ¤íŠ¸ìŠ¬ë¦½ ${branch}ì…ë‹ˆë‹¤. ë°©ë¬¸ì‹œ ì²´í—˜í•˜ì‹  ì œí’ˆì˜ ì •ë³´ ìƒì„¸íˆ ì†¡ë¶€ë“œë¦½ë‹ˆë‹¤. 
ì €í¬ ì²´í—˜ê´€ì„ ì°¾ì•„ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. 

ğŸë§¤ì¥ ë°©ë¬¸ì‹œ í’ì„±í•œ í˜œíƒì œê³µğŸ
í˜¹ì—¬ ì¬ë°©ë¬¸ì´ ì–´ë ¤ìš°ì‹¤ ê²½ìš°, ì „í™”ì£¼ë¬¸ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.(ì¹´ë“œ ê²°ì œ, ë¬´ì´ìí• ë¶€, ë„¤ì´ë²„ í˜ì´ ê°€ëŠ¥) 

ê³ ê°ë‹˜ê»˜ì„œ ì²´í—˜í•˜ì…¨ë˜ ${names.join(", ")} ì…ë‹ˆë‹¤

${detail.trim()}

ë¬¸ì˜ ì‚¬í•­ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½í•´ ì£¼ì„¸ìš” :)

ğŸŒˆì²´í—˜ê´€ì„ í†µí•´ êµ¬ë§¤í•˜ì‹œë©´ 
1ï¸âƒ£ì˜¨ì˜¤í”„ë¼ì¸ í†µí•© ìµœì €ê°€ ìˆ˜ì¤€ì˜ íŒë§¤ê°€
2ï¸âƒ£ì‚¬ì€í’ˆ ì¦ì • (ì˜¨ë¼ì¸ êµ¬ë§¤ ì‹œ ë¯¸ì¦ì •) 
3ï¸âƒ£ë¹ ë¥¸ ì£¼ë¬¸ì ‘ìˆ˜ ë° ë°°ì†¡ ì•ˆë‚´ 
4ï¸âƒ£AS ë°œìƒ ì‹œ ìˆ˜ì›”í•œ ì²˜ë¦¬ ë“± 
5ï¸âƒ£ë„ë„í¬ì¸íŠ¸ì ë¦½(êµ¬ë§¤ê¸ˆì•¡ì˜ 1.7%)

ì¢‹ì€ í˜œíƒì„ ë§ì´ ë°›ì•„ ê°€ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
ê·¸ëŸ¼, ì˜¤ëŠ˜ë„ í–‰ë³µí•œ í•˜ë£¨ ë³´ë‚´ì‹œê³  
ìˆ™ë©´ ì·¨í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤:)
      `.trim();

      document.getElementById("output").textContent = message;
      document.getElementById("copyBtn").style.display = "inline-block";
    }

    function deselectAllProducts() {
      const selectedButtons = document.querySelectorAll(".product-button.selected");
      selectedButtons.forEach(button => {
        button.classList.remove("selected");
      });
      document.getElementById("output").textContent = "";
      document.getElementById("copyBtn").style.display = "none";
    }

    function copyMessage() {
      // navigator.clipboard.writeText()ëŠ” iframe í™˜ê²½ì—ì„œ ì œí•œë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, document.execCommand('copy')ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      const message = document.getElementById("output").textContent;
      const tempTextArea = document.createElement("textarea");
      tempTextArea.value = message;
      document.body.appendChild(tempTextArea);
      tempTextArea.select();
      
      try {
        const successful = document.execCommand('copy');
        const msg = successful ? 'ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        showMessageBox(msg, successful ? "success" : "danger");
      } catch (err) {
        showMessageBox('ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', "danger");
      }
      
      document.body.removeChild(tempTextArea);
    }
    
    // Alert() ëŒ€ì‹  ì‚¬ìš©í•  ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ êµ¬í˜„ (ê°„ë‹¨ ë²„ì „)
    function showMessageBox(message, type) {
        const colorMap = {
            'warn': 'var(--warn)',
            'success': 'var(--success)',
            'danger': 'var(--danger)'
        };
        
        const style = `position: fixed; top: 10px; right: 10px; padding: 10px 20px; background: ${colorMap[type] || 'gray'}; color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; transition: opacity 0.3s ease-in-out;`;
        
        let box = document.getElementById('custom-message-box');
        if (!box) {
            box = document.createElement('div');
            box.id = 'custom-message-box';
            document.body.appendChild(box);
        }
        
        box.style.cssText = style;
        box.textContent = message;
        box.style.opacity = 1;

        clearTimeout(box.timer);
        box.timer = setTimeout(() => {
            box.style.opacity = 0;
        }, 3000);
    }

    // ê´€ë¦¬ì ëª¨ë“œ UI
    const modeSelect = document.getElementById("modeSelect");
    const adminPassword = document.getElementById("adminPassword");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminPanel = document.getElementById("adminPanel");

    modeSelect.addEventListener("change", () => {
      if (modeSelect.value === "admin") {
        adminPassword.style.display = "inline-block";
        adminLoginBtn.style.display = "inline-block";
        adminPassword.focus();
      } else {
        adminPassword.style.display = "none";
        adminLoginBtn.style.display = "none";
        adminPanel.style.display = "none";
      }
    });

    adminLoginBtn.addEventListener("click", () => {
      const pw = adminPassword.value.trim();
      // ë¹„ë°€ë²ˆí˜¸ëŠ” "040305"ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
      if (pw === "040305") {
        showMessageBox("ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ", "success");
        adminPanel.style.display = "block";
        renderAdminList();
      } else {
        showMessageBox("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "danger");
      }
    });

    function addProduct() {
      const brand = document.getElementById("adminBrand").value.trim();
      const name = document.getElementById("adminName").value.trim();
      const url = document.getElementById("adminURL").value.trim();
      if (!brand || !name || !url) {
        showMessageBox("ë¸Œëœë“œëª…, ì œí’ˆëª…, URL ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warn");
        return;
      }
      if (productData[name]) {
        showMessageBox("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì œí’ˆëª…ì…ë‹ˆë‹¤.", "warn");
        return;
      }
      productData[name] = { brand, url };
      if (!productOrder[brand]) productOrder[brand] = [];
      productOrder[brand].push(name);
      // ë¸Œëœë“œê°€ brandOrderì— ì—†ìœ¼ë©´ ì¶”ê°€
      if (!brandOrder.includes(brand)) brandOrder.push(brand);
      if (!collapsedState[brand]) collapsedState[brand] = false;

      saveAllData(); // Firebaseì— ì €ì¥

      document.getElementById("adminBrand").value = "";
      document.getElementById("adminName").value = "";
      document.getElementById("adminURL").value = "";
    }

    function removeProduct(name) {
        // confirm ëŒ€ì‹  ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ ì‚¬ìš© (ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©)
        if (confirm(`ì œí’ˆ "${name}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
            const brand = productData[name].brand;
            delete productData[name];
            if (productOrder[brand]) {
            productOrder[brand] = productOrder[brand].filter(n => n !== name);
            }
            // ë§Œì•½ ë¸Œëœë“œì— ì œí’ˆì´ í•˜ë‚˜ë„ ë‚¨ì§€ ì•Šìœ¼ë©´ ë¸Œëœë“œ ìì²´ë„ ì œê±°
            if (productOrder[brand] && productOrder[brand].length === 0) {
            delete productOrder[brand];
            brandOrder = brandOrder.filter(b => b !== brand);
            delete collapsedState[brand];
            }
            saveAllData(); // Firebaseì— ì €ì¥
        }
    }

    function enterEditMode(container, oldName, oldData) {
      container.innerHTML = "";

      const brandInput = document.createElement("input");
      brandInput.value = oldData.brand;

      const nameInput = document.createElement("input");
      nameInput.value = oldName;

      const urlInput = document.createElement("input");
      urlInput.value = oldData.url;

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "ğŸ’¾ ì €ì¥";
      saveBtn.onclick = () => {
        const newBrand = brandInput.value.trim();
        const newName = nameInput.value.trim();
        const newURL = urlInput.value.trim();

        if (!newBrand || !newName || !newURL) {
          showMessageBox("ëª¨ë“  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "warn");
          return;
        }

        if (newName !== oldName) {
          // oldName í‚¤ ì œê±°
          delete productData[oldName];
        }

        // ë¸Œëœë“œ ë³€ê²½ ì‹œ ìˆœì„œì—ì„œ ì¡°ì •
        if (newBrand !== oldData.brand) {
          // old ë¸Œëœë“œ ìˆœì„œì—ì„œ ì œê±°
          if (productOrder[oldData.brand]) {
            productOrder[oldData.brand] = productOrder[oldData.brand].filter(n => n !== oldName);
          }
          // ìƒˆ ë¸Œëœë“œê°€ brandOrderì— ì—†ìœ¼ë©´ ì¶”ê°€
          if (!brandOrder.includes(newBrand)) brandOrder.push(newBrand);
          if (!collapsedState[newBrand]) collapsedState[newBrand] = false;
        }

        productData[newName] = { brand: newBrand, url: newURL };

        // ìƒˆë¸Œëœë“œ ìˆœì„œì— ì œí’ˆ ì¶”ê°€
        if (!productOrder[newBrand]) productOrder[newBrand] = [];
        if (!productOrder[newBrand].includes(newName)) {
          productOrder[newBrand].push(newName);
        }

        // ë§Œì•½ oldë¸Œëœë“œì— ì œí’ˆì´ í•˜ë‚˜ë„ ë‚¨ì§€ ì•Šìœ¼ë©´ ë¸Œëœë“œ ì œê±°
        if (productOrder[oldData.brand] && productOrder[oldData.brand].length === 0) {
          delete productOrder[oldData.brand];
          brandOrder = brandOrder.filter(b => b !== oldData.brand);
          delete collapsedState[oldData.brand];
        }

        saveAllData(); // Firebaseì— ì €ì¥
      };

      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "âŒ ì·¨ì†Œ";
      cancelBtn.onclick = () => renderAdminList();

      container.appendChild(brandInput);
      container.appendChild(nameInput);
      container.appendChild(urlInput);
      container.appendChild(saveBtn);
      container.appendChild(cancelBtn);
    }

    // ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í´ê¸° ë¡œì§
    function toggleAdminCategory(event) {
      const brandItem = event.currentTarget;
      const brand = brandItem.dataset.brand;
      
      // ì ‘ê¸°/í´ê¸° ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
      if (event.target.classList.contains('brand-handle')) return; 
      if (event.target.tagName === 'SPAN' && event.target.textContent === brand) return; 

      const isCollapsed = brandItem.dataset.collapsed === "true";
      brandItem.dataset.collapsed = !isCollapsed;
      collapsedState[brand] = !isCollapsed;
      saveAllData(); // Firebaseì— ì €ì¥

      const list = document.getElementById("adminList");
      let foundBrand = false;
      Array.from(list.children).forEach(child => {
        if (child === brandItem) {
          foundBrand = true;
          return;
        }
        if (foundBrand) {
          if (child.classList.contains('brand-item')) {
            foundBrand = false;
          } else if (child.classList.contains('admin-item') && child.dataset.brand === brand) {
            child.classList.toggle('hidden', !isCollapsed);
          }
        }
      });
    }

    function renderAdminList() {
      const list = document.getElementById("adminList");
      list.innerHTML = "";
      ensureBrandOrder();
      ensureProductOrder();
      const grouped = groupByBrand(productData);

      // ë¸Œëœë“œ í•­ëª© ë¦¬ìŠ¤íŠ¸ (ë¸Œëœë“œ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)
      brandOrder.forEach(brand => {
        const bdiv = document.createElement("div");
        bdiv.className = "brand-item";
        bdiv.draggable = true;
        bdiv.dataset.brand = brand;
        // ì ‘ê¸°/í´ê¸° ìƒíƒœ ì ìš©
        const isCollapsed = collapsedState[brand] || false;
        bdiv.dataset.collapsed = isCollapsed;
        bdiv.onclick = toggleAdminCategory;

        const handle = document.createElement("span");
        handle.className = "brand-handle";
        handle.textContent = "â‰¡"; 
        bdiv.appendChild(handle);

        const bspan = document.createElement("span");
        bspan.textContent = brand;
        bdiv.appendChild(bspan);

        const toggleBtn = document.createElement("span");
        toggleBtn.className = "toggle-btn";
        toggleBtn.textContent = "â–¼";
        bdiv.appendChild(toggleBtn);
        
        list.appendChild(bdiv);

        // ì œí’ˆ í•­ëª©ë“¤
        productOrder[brand].forEach(name => {
          if (!(name in productData)) return;
          const data = productData[name];
          const div = document.createElement("div");
          div.className = "admin-item";
          div.draggable = true;
          div.dataset.productName = name;
          div.dataset.brand = brand;
          // ì ‘ê¸°/í´ê¸° ìƒíƒœì— ë”°ë¼ ì´ˆê¸° ìˆ¨ê¹€ ì²˜ë¦¬
          if (isCollapsed) {
            div.classList.add('hidden');
          }

          const handle2 = document.createElement("span");
          handle2.className = "draggable-handle";
          handle2.textContent = "â‰¡";
          div.appendChild(handle2);

          const span = document.createElement("span");
          span.textContent = `${data.brand} - ${name}`;
          div.appendChild(span);

          const editBtn = document.createElement("button");
          editBtn.textContent = "âœï¸ ìˆ˜ì •";
          editBtn.onclick = (e) => {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            enterEditMode(div, name, data);
          };
          div.appendChild(editBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "âŒ ì‚­ì œ";
          deleteBtn.onclick = (e) => {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            removeProduct(name);
          };
          div.appendChild(deleteBtn);

          list.appendChild(div);
        });
      });

      addDragAndDropListenersAdmin();
    }

    function addDragAndDropListenersAdmin() {
      const list = document.getElementById("adminList");
      let dragSrcEl = null;
      let dragType = null; // "brand" or "product"

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
      list.querySelectorAll('.brand-item, .admin-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          dragSrcEl = item;
          dragType = item.classList.contains('brand-item') ? 'brand' : 'product';
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', null);
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          const target = e.target.closest('.brand-item, .admin-item');
          if (!target || target === dragSrcEl) return;
          // ë¸Œëœë“œ ì•„ì´í…œ ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ
          if (dragType === 'brand' && target.classList.contains('brand-item')) {
            const bounding = target.getBoundingClientRect();
            const offset = e.clientY - bounding.top;
            if (offset > bounding.height / 2) {
              list.insertBefore(dragSrcEl, target.nextSibling);
            } else {
              list.insertBefore(dragSrcEl, target);
            }
          }
          // ì œí’ˆ ì•„ì´í…œ ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ
          if (dragType === 'product' && target.classList.contains('admin-item')) {
            // ì œí’ˆì€ ê°™ì€ ë¸Œëœë“œ ë‚´ì—ì„œë§Œ ìˆœì„œ ë³€ê²½ í—ˆìš©
            if (target.dataset.brand === dragSrcEl.dataset.brand) {
              const bounding2 = target.getBoundingClientRect();
              const offset2 = e.clientY - bounding2.top;
              if (offset2 > bounding2.height / 2) {
                list.insertBefore(dragSrcEl, target.nextSibling);
              } else {
                list.insertBefore(dragSrcEl, target);
              }
            }
          }
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          saveOrderFromAdminListAdmin();
        });
      });
    }

    function saveOrderFromAdminListAdmin() {
      const list = document.getElementById("adminList");
      const newBrandOrder = [];
      const newProductOrder = {};

      let currentBrand = null;
      Array.from(list.children).forEach(child => {
        if (child.classList.contains('brand-item')) {
          const brand = child.dataset.brand;
          currentBrand = brand;
          if (!newBrandOrder.includes(brand)) {
            newBrandOrder.push(brand);
          }
          if (!newProductOrder[brand]) {
            newProductOrder[brand] = [];
          }
        } else if (child.classList.contains('admin-item')) {
          const name = child.dataset.productName;
          const brand = child.dataset.brand;
          if (brand === currentBrand) {
            newProductOrder[brand].push(name);
          } else {
            // ë¸Œëœë“œ í—¤ë”ë‘ ë§¤ì¹˜ ì•ˆë˜ëŠ” ê²½ìš°ëŠ” ë¬´ì‹œí•˜ê±°ë‚˜ brand ì •ë³´ ì‚¬ìš©
            if (!newProductOrder[brand]) newProductOrder[brand] = [];
            newProductOrder[brand].push(name);
          }
        }
      });

      brandOrder = newBrandOrder;
      productOrder = newProductOrder;
      saveAllData(); // Firebaseì— ì €ì¥
    }

    // function saveAllData() { ... } // ì´ í•¨ìˆ˜ëŠ” ìœ„ì—ì„œ Firebase ë²„ì „ìœ¼ë¡œ ì¬ì •ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.
    
    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    // ì´ˆê¸° ì‹¤í–‰: Firebase ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ ì‹œì‘
    initFirebase();
    
  </script>
</body>
</html>
